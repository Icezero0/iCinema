# 后端开发需求记录

本文件用于记录 backend 目录下后端开发的需求、任务、变更及相关说明。

**最后更新时间：2025-06-16**
**重构状态：WebSocket实时通信系统已完成基础架构**

# 需求列表

## 0. 需求记录模板
   - 需求描述：
     - 用简明的条目描述该需求要实现的功能或目标。
   - 相关模块：
     - 涉及的主要代码文件或目录（如 app/api/xxx.py、app/crud/xxx.py 等）。
   - 相关API：
     - 用表格列出涉及的接口（如 POST /users/ 注册）。
   - 备注：
     - 其他需要注意的事项、实现建议或特殊说明。

## 1. 用户管理

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 用户注册与登录                             |    ✅     |
| 邮箱和用户名唯一性校验                     |    ✅     |
| 密码加密存储 (bcrypt)                      |    ✅     |
| JWT鉴权 (Access Token, Refresh Token)      |    ✅     |
| Token 校验接口                             |    ✅     |
| 获取当前用户信息 (包含拥有/加入的房间)     |    ✅     |
| 个人信息更新（用户名、头像、密码）          |    ✅     |
| 头像文件上传与Base64处理                   |    ✅     |
| 获取指定用户信息 (ID)                      |   🔄注释   |

- 相关模块：
  - `app/api/users.py`
  - `app/crud/users.py`
  - `app/models.py` (User model)
  - `app/schemas.py` (User schemas)
  - `app/database.py` (get_db dependency)
- 相关API：

  | 方法 | 路径             | 说明                       | 状态 |
  | ---- | ---------------- | -------------------------- |:----:|
  | POST | /users/          | 注册新用户                 |  ✅   |
  | POST | /token           | 用户登录 (获取Token)       |  ✅   |
  | POST | /token/refresh   | 刷新Access Token           |  ✅   |
  | GET  | /token/check     | 校验Access Token           |  ✅   |
  | GET  | /users/me        | 获取当前登录用户信息       |  ✅   |
  | PUT  | /users/me        | 更新当前登录用户信息       |  ✅   |
  | GET  | /users/{user_id} | 获取指定ID的用户信息       | 🔄注释 |

- 备注：
  - 头像通过 Base64 编码上传，后端解码并存储文件，支持jpg/png/webp格式。
  - 密码更新时会重新哈希。
  - 用户详情接口支持返回房间列表信息（拥有的房间和加入的房间）。
  - 获取指定用户信息的接口已实现但被注释，需要时可启用。

## 2. 房间管理

| 需求描述                                       |   状态   |
| ---------------------------------------------- |:--------:|
| 房主创建房间                                   |    ✅     |
| 房主解散房间                                   |    ✅     |
| 获取房间基本信息                               |    ✅     |
| 获取房间详细信息 (含房主、成员列表)            |    ✅     |
| 房主更新房间信息 (如名称)                      |    ✅     |
| **邀请/申请加入房间流程 (通过通知系统)**       |    ✅     |
|   - 房主邀请用户加入                           |    ✅     |
|   - 用户申请加入房间                           |    ✅     |
|   - 成员邀请其他用户加入                       |    ✅     |
| 用户实际加入/退出房间 (接受/拒绝邀请后的操作)  |    ✅     |
| 房间成员移除功能 (房主权限/用户自主退出)        |    ✅     |
| 房间页面根据身份展示不同内容 (后端权限支持)    |   📋待办   |
| 房间参数设置（公开、同意、聊天记录、同步等）   |   📋待办   |

- 相关模块：
  - `app/api/rooms.py`
  - `app/crud/rooms.py`
  - `app/crud/notifications.py` (用于邀请/申请流程)
  - `app/models.py` (Room, room_members models)
  - `app/schemas.py` (Room schemas)
- 相关API：

  | 方法   | 路径                      | 说明                                     | 状态 |
  | ------ | ------------------------- | ---------------------------------------- |:----:|
  | POST   | /rooms/                   | 创建房间                                 |  ✅   |
  | DELETE | /rooms/{room_id}          | 解散房间 (仅房主)                        |  ✅   |
  | GET    | /rooms/{room_id}          | 获取房间基本信息                         |  ✅   |
  | GET    | /rooms/{room_id}/details  | 获取房间详细信息                         |  ✅   |
  | PUT    | /rooms/{room_id}          | 更新房间信息 (仅房主)                    |  ✅   |
  | POST   | /rooms/{room_id}/members  | 发起邀请/申请加入房间 (创建通知)         |  ✅   |
  | DELETE | /rooms/{room_id}/members/{user_id} | 移除房间成员 (房主权限/用户自主) |  ✅   |
  | POST   | /rooms/join               | (原) 用户加入房间 (逻辑已整合)           | 🔄已整合 |
  | POST   | /rooms/leave              | (原) 用户退出房间 (逻辑已整合)           | 🔄已整合 |
  | PUT    | /rooms/{id}/config        | (原) 修改房间参数 (逻辑待实现)           | 📋待办 |


- 备注：
  - 房间邀请/申请流程完全通过通知系统实现，支持三种类型：
    - `owner_invitation`: 房主邀请用户加入
    - `member_invitation`: 成员邀请用户加入 
    - `join_request`: 用户申请加入房间
  - 通知响应机制已完善，支持token验证确保安全性。
  - 成员管理功能完整，支持房主移除成员和用户自主退出。
  - 房间参数设置、房主/宾客身份区分、页面展示差异需前后端配合实现。

## 3. 通知系统

| 需求描述                                       |   状态   |
| ---------------------------------------------- |:--------:|
| 通知模型 (`Notification`) 设计与实现           |    ✅     |
| API：创建通知 (系统内部调用)                   |    ✅     |
| API：获取用户通知列表 (分页、状态筛选)         |    ✅     |
| API：更新通知状态 (已读/未读)                  |    ✅     |
| API：响应邀请/申请通知 (接受/拒绝)             |    ✅     |
| 通知内容结构化存储 (JSON格式)                  |    ✅     |
| 通知安全验证 (Token机制)                       |    ✅     |
| 房间邀请/申请完整流程实现                      |    ✅     |
| WebSocket实时通知推送                          |   📋待办   |
- 相关模块：
  - `app/api/notifications.py`
  - `app/crud/notifications.py`
  - `app/utils/notifications.py` (通知内容生成工具)
  - `app/models.py` (Notification model)
  - `app/schemas.py` (Notification schemas)
- 相关API：

  | 方法 | 路径                               | 说明                         | 状态 |
  | ---- | ---------------------------------- | ---------------------------- |:----:|
  | GET  | /notifications/                    | 获取用户通知列表 (分页筛选)  |  ✅   |
  | POST | /notifications/{id}/respond        | 响应邀请/申请通知            |  ✅   |

- 备注：
  - 通知内容采用JSON结构化存储，包含type、room_id、user_id、token等字段。
  - 支持三种通知类型：房主邀请、成员邀请、用户申请。
  - 通知响应支持accept/reject操作，包含token验证机制。
  - 成员邀请会转化为对房主的申请通知，实现二次确认。
  - WebSocket实时推送功能规划中，目前通过TODO标记。

## 4. WebSocket 实时通信与房间活跃状态管理 ✨

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| WebSocket 连接管理与身份认证               |    ✅     |
| 用户连接注册与断开处理                     |    ✅     |
| 房间加入/离开的 WebSocket 消息处理         |    ✅     |
| 房间活跃状态与数据库实时同步               |    ✅     |
| WebSocket 心跳机制 (ping/pong)             |    ✅     |
| 房间内用户状态管理 (内存 + 数据库)         |    ✅     |
| 实时消息广播到房间在线成员                 |    ✅     |
| WebSocket 错误处理与日志记录               |    ✅     |
| 混合架构：HTTP API + WebSocket 广播        |    ✅     |
| 支持断线重连与异常处理                     |    ✅     |

- 相关模块：
  - `app/websocket/manager.py` - 连接管理和房间状态管理
  - `app/websocket/handler.py` - WebSocket 消息处理
  - `app/websocket/routes.py` - WebSocket 路由端点
  - `app/crud/rooms.py` - 房间活跃状态数据库操作
  - `app/api/messages.py` - HTTP 消息 API (含 WebSocket 广播)

- WebSocket API：

  | 端点 | 说明                       | 状态 |
  | ---- | -------------------------- |:----:|
  | GET /ws/status  | WebSocket 连接状态查询     |  ✅   |
  | WS /ws          | WebSocket 连接端点         |  ✅   |

### 4.1 WebSocket 消息协议

#### **客户端 → 服务器**
| 消息类型 | 描述 | 负载格式 | 状态 |
|---------|-----|---------|:----:|
| `ping` | 心跳检测 | `{"timestamp": "..."}` | ✅ |
| `join_room` | 加入房间 | `{"room_id": 123}` | ✅ |
| `leave_room` | 离开房间 | `{"room_id": 123}` | ✅ |

#### **服务器 → 客户端**
| 消息类型 | 描述 | 负载格式 | 状态 |
|---------|-----|---------|:----:|
| `pong` | 心跳响应 | `{"timestamp": "..."}` | ✅ |
| `room_joined` | 加入房间成功 | `{"room_id": 123, "status": "success", "active_users": 5}` | ✅ |
| `room_left` | 离开房间成功 | `{"room_id": 123, "status": "success"}` | ✅ |
| `room_message` | 接收房间消息 | `{"id": 456, "room_id": 123, "sender_id": 789, "sender_username": "用户名", "content": "消息内容", "timestamp": "2025-06-16T..."}` | ✅ |
| `room_join_error` | 加入房间失败 | `{"status": "failed", "message": "错误信息"}` | ✅ |
| `room_leave_error` | 离开房间失败 | `{"status": "error", "message": "错误信息"}` | ✅ |
| `error` | 通用错误 | `{"message": "错误信息", "supported_types": [...]}` | ✅ |

### 4.2 架构设计

**混合架构模式**：
```
消息发送：前端 → HTTP API → 数据库 → WebSocket 广播 → 其他在线用户
房间管理：前端 → WebSocket → 数据库验证 → 状态更新
```

**核心特性**：
- ✅ **双重认证**：支持 Header Bearer token 和连接后认证
- ✅ **权限验证**：所有房间操作都验证用户权限和房间成员关系
- ✅ **状态同步**：内存中的活跃房间状态与数据库实时同步
- ✅ **错误处理**：完整的错误处理和用户友好的错误消息
- ✅ **资源管理**：自动清理断开连接和空房间

### 4.3 数据库集成

| 操作 | 数据库功能 | 实现位置 | 状态 |
|-----|----------|----------|:----:|
| 加入房间 | 验证房间存在性、用户权限、更新活跃状态 | `manager.join_room()` | ✅ |
| 离开房间 | 更新房间活跃状态 | `manager.leave_room()` | ✅ |
| 用户断开 | 批量更新空房间状态 | `manager.disconnect()` | ✅ |
| 房间状态 | `rooms.is_active` 字段同步 | `crud.rooms.update_room_active_status()` | ✅ |

- 备注：
  - **实时性与一致性**：WebSocket 提供实时交互，数据库确保状态持久化
  - **性能优化**：房间状态更新使用异步任务，避免阻塞主连接
  - **扩展性**：支持多房间并发管理，内存使用高效
  - **可观测性**：完整的日志记录和状态查询接口

## 5. 聊天消息系统 ✨

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 聊天消息模型 (`Message`) 设计与实现        |    ✅     |
| HTTP API：发送聊天消息 + WebSocket 广播    |    ✅     |
| API：获取房间历史聊天消息 (分页)           |    ✅     |
| API：获取单条消息详情                      |    ✅     |
| 聊天消息持久化存储                         |    ✅     |
| 消息权限控制 (仅房间成员可发送/查看)       |    ✅     |
| 实时消息发送与接收 (混合架构)              |    ✅     |
| 消息编辑功能                               |   🔄注释   |
| 消息删除功能                               |   �注释   |

- 相关模块：
  - `app/models.py` (Message model)
  - `app/api/messages.py` - HTTP 消息 API (包含 WebSocket 广播)
  - `app/crud/messages.py` - 消息数据库操作
  - `app/schemas.py` (Message schemas)
  - `app/websocket/manager.py` - 消息广播功能
  
- 相关API：
  | 方法 | 路径                        | 说明               | 状态 |
  | ---- | --------------------------- | ------------------ |:----:|
  | POST | /rooms/{room_id}/messages/  | 发送聊天消息 + 实时广播 |  ✅   |
  | GET  | /rooms/{room_id}/messages/  | 获取历史聊天消息   |  ✅   |
  | GET  | /messages/{message_id}      | 获取单条消息详情   |  ✅   |

### 5.1 混合架构实现

**消息发送流程**：
```
前端 → HTTP POST /rooms/{room_id}/messages/ → 数据库持久化 → WebSocket 广播 → 房间内其他用户实时接收
```

**关键特性**：
- ✅ **可靠性**：消息必定保存到数据库，广播失败不影响数据完整性
- ✅ **实时性**：通过 WebSocket 立即推送给房间内在线用户
- ✅ **权限控制**：发送和接收都验证房间成员权限
- ✅ **丰富信息**：消息包含 ID、发送者信息、时间戳等完整数据
- ✅ **状态反馈**：返回实际送达的在线用户数量

**HTTP 响应示例**：
```json
{
  "message": "消息发送成功",
  "message_id": 456,
  "sent_to_online_users": 3,
  "timestamp": "2025-06-16T10:30:00Z"
}
```

**WebSocket 广播格式**：
```json
{
  "type": "room_message",
  "payload": {
    "id": 456,
    "room_id": 123,
    "sender_id": 789,
    "sender_username": "用户名",
    "content": "消息内容",
    "timestamp": "2025-06-16T10:30:00Z"
  }
}
```

- 备注：
  - **职责分离**：HTTP API 负责持久化和权限，WebSocket 负责实时推送
  - **向后兼容**：可以纯通过 HTTP API 使用，WebSocket 为增强功能
  - **扩展性**：未来可以添加消息状态（已读/未读）、编辑历史等功能
  - **性能考虑**：大房间消息广播使用异步处理，不阻塞 HTTP 响应

## 6. 权限控制

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 细化API接口的权限校验                      |    ✅     |
|   - 只有房主能解散房间、修改房间信息       |    ✅     |
|   - 只有房间成员才能发送/查看消息          |    ✅     |
|   - 只有房主/本人可以移除房间成员          |    ✅     |
|   - 通知操作权限验证                       |    ✅     |
| 基于角色的访问控制 (RBAC) - (可选/未来)    |   📋规划   |
| JWT Token权限依赖项                        |    ✅     |

- 备注：
  - 目前通过 `get_current_user` 和业务逻辑检查实现权限控制。
  - 房间操作权限：房主ID验证、成员关系验证等。
  - 消息操作权限：房间成员身份验证。
  - 通知操作权限：接收者身份验证、Token验证等。
  - 未来可以考虑更通用的权限依赖项或中间件。

## 7. 数据库迁移 (Alembic)

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| Alembic 配置与环境设置                     |    ✅     |
| 已有模型对应的迁移脚本                     |    ✅     |
|   - `31ba4580cbae_update_id_sequences.py`  |    ✅     |
|   - 其他历史迁移脚本                       |    ✅     |
| 数据库表自动创建 (通过lifespan)            |    ✅     |

- 相关模块：
  - `alembic/` 目录
  - `alembic.ini`
  - `app/main.py` (lifespan管理)
- 备注：
  - 确保模型变更时及时生成和应用新的迁移脚本。
  - 应用启动时会自动创建数据库表结构。

## 8. 其他

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 静态文件服务 (avatars, general static)     |    ✅     |
| CORS 配置                                  |    ✅     |
| 应用生命周期管理 (数据库表创建)            |    ✅     |
| Dockerfile 用于构建后端镜像                |    ✅     |
| FastAPI 自动生成API文档                    |    ✅     |
| 异步数据库操作 (SQLAlchemy + aiosqlite)    |    ✅     |
| Pydantic数据验证与序列化                   |    ✅     |
| 单元测试/集成测试                          |   📋待办   |
| 日志记录                                   |   📋待办   |
| 环境变量配置                               |   📋待办   |
| 生产环境安全配置                           |   📋待办   |

## 9. 当前开发重点

### 🚀 **已完成的核心功能**
- ✅ **完整的用户认证系统** (注册/登录/JWT/头像上传)
- ✅ **房间管理系统** (创建/管理/成员邀请/权限控制)
- ✅ **通知系统** (邀请/申请流程/Token验证)
- ✅ **聊天消息系统** (HTTP API + WebSocket 实时广播)
- ✅ **WebSocket 实时通信** (连接管理/房间状态/消息广播)
- ✅ **房间活跃状态管理** (内存+数据库双重同步)
- ✅ **权限控制机制** (细粒度权限验证)
- ✅ **数据库模型和迁移** (完整的数据结构)

### 🔄 **下一步开发计划**

#### **高优先级**
1. **视频同步功能** 🎬
   - 播放状态同步 (播放/暂停/跳转)
   - 进度同步与同步控制
   - 视频文件管理
   - 房主控制权限

2. **通知实时推送** 📢
   - 集成 WebSocket 到通知系统
   - 实时邀请/申请通知
   - 在线状态检测

#### **中优先级**
3. **系统完善** 🔧
   - 日志记录系统
   - 环境变量配置
   - 错误处理优化
   - 性能监控

4. **功能增强** ⭐
   - 房间设置 (公开/私密/同步模式等)
   - 用户在线状态显示
   - 消息已读状态

#### **低优先级**
5. **测试与运维** 🧪
   - 单元测试覆盖
   - 集成测试
   - 生产环境安全配置
   - API 文档完善

### 📊 **开发进度总结**
- **用户管理**: 95% 完成 ✅
- **房间管理**: 95% 完成 ✅  
- **通知系统**: 90% 完成 (缺少实时推送)
- **消息系统**: 100% 完成 ✅
- **WebSocket通信**: 100% 完成 ✅
- **房间状态管理**: 100% 完成 ✅
- **视频同步**: 0% 完成 📋
- **系统完善**: 30% 完成

### 🏗️ **架构成就**

#### **混合架构设计** 
成功实现了 HTTP API + WebSocket 的混合架构：
- **数据操作**：通过标准 HTTP API 进行，便于测试和集成
- **实时通信**：通过 WebSocket 进行，提供即时响应
- **状态管理**：内存+数据库双重同步，确保一致性和性能

#### **核心技术栈**
- **后端框架**：FastAPI + SQLAlchemy + Alembic
- **数据库**：SQLite (async) + aiosqlite
- **实时通信**：WebSocket + 自定义连接管理器
- **认证授权**：JWT + Bearer Token
- **数据验证**：Pydantic schemas

#### **代码质量**
- **模块化设计**：清晰的 API/CRUD/WebSocket/Schema 分层
- **错误处理**：完整的异常处理和用户友好错误消息
- **权限控制**：细粒度的权限验证机制
- **异步优化**：全面使用异步操作，提升性能

## 10. 技术实现细节 📋

### 10.1 WebSocket 连接管理器 (ConnectionManager)

**核心职责**：
```python
class ConnectionManager:
    - connections: Dict[int, WebSocket]         # 用户连接映射
    - active_room_users: Dict[int, Set[int]]    # 房间活跃用户
```

**关键方法**：
- `register_connection()` - 注册用户连接
- `disconnect()` - 断开连接并清理房间状态
- `join_room()` - 加入房间（含数据库验证）
- `leave_room()` - 离开房间并更新状态
- `broadcast_to_room()` - 房间消息广播
- `send_to_user()` - 点对点消息发送

**数据库集成**：
- 自动管理 `rooms.is_active` 状态
- 验证房间存在性和用户权限
- 异步处理状态更新，避免阻塞

### 10.2 消息系统架构

**HTTP API + WebSocket 混合模式**：
```
发送消息：POST /rooms/{id}/messages/ → DB → WebSocket广播
接收消息：WebSocket 监听 "room_message" 事件
```

**数据流**：
1. 前端通过 HTTP API 发送消息
2. 后端验证权限并保存到数据库
3. 调用 WebSocket manager 广播给在线用户
4. 返回发送状态（包含在线用户数）

### 10.3 房间状态同步机制

**双重状态管理**：
- **内存状态**：`active_room_users` 快速查询在线用户
- **数据库状态**：`rooms.is_active` 持久化房间活跃状态

**同步策略**：
- 房间从空变非空 → 设置 `is_active = True`
- 房间从非空变空 → 设置 `is_active = False`
- 用户断开连接 → 批量更新所有相关空房间

### 10.4 错误处理策略

**分层错误处理**：
1. **WebSocket 层**：连接错误、认证失败、协议错误
2. **业务逻辑层**：权限不足、房间不存在、参数错误
3. **数据库层**：连接失败、事务回滚、约束违反

**用户友好设计**：
- 所有错误都有清晰的中文描述
- 错误响应包含错误类型和具体原因
- 支持的操作类型提示

### 10.5 性能优化措施

**异步处理**：
- 房间状态更新使用 `asyncio.create_task()`
- 避免数据库操作阻塞 WebSocket 连接
- 消息广播采用并发发送

**内存优化**：
- 及时清理断开的连接
- 空房间自动从内存中移除
- 使用 Set 数据结构高效管理用户集合

**数据库优化**：
- 使用连接池和会话管理
- 批量状态更新减少数据库调用
- 索引优化（room_id, user_id）

> **文档持续更新**：请在功能变更时及时更新此文档。
