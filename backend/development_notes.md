# 后端开发需求记录

本文件用于记录 backend 目录下后端开发的需求、任务、变更及相关说明。

**最后更新时间：2025-06-14**

# 需求列表

## 0. 需求记录模板
   - 需求描述：
     - 用简明的条目描述该需求要实现的功能或目标。
   - 相关模块：
     - 涉及的主要代码文件或目录（如 app/api/xxx.py、app/crud/xxx.py 等）。
   - 相关API：
     - 用表格列出涉及的接口（如 POST /users/ 注册）。
   - 备注：
     - 其他需要注意的事项、实现建议或特殊说明。

## 1. 用户管理

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 用户注册与登录                             |    √     |
| 邮箱和用户名唯一性校验                     |    √     |
| 密码加密存储 (bcrypt)                      |    √     |
| JWT鉴权 (Access Token, Refresh Token)      |    √     |
| Token 校验接口                             |    √     |
| 获取当前用户信息 (包含拥有/加入的房间)     |    √     |
| 个人信息更新（用户名、头像、密码）          |    √     |
| 获取指定用户信息 (ID)                      |    待办    |

- 相关模块：
  - `app/api/users.py`
  - `app/crud/users.py`
  - `app/models.py` (User model)
  - `app/schemas.py` (User schemas)
  - `app/database.py` (get_db dependency)
- 相关API：

  | 方法 | 路径             | 说明                       | 状态 |
  | ---- | ---------------- | -------------------------- |:----:|
  | POST | /users/          | 注册新用户                 |  √   |
  | POST | /token           | 用户登录 (获取Token)       |  √   |
  | POST | /token/refresh   | 刷新Access Token           |  √   |
  | GET  | /token/check     | 校验Access Token           |  √   |
  | GET  | /users/me        | 获取当前登录用户信息       |  √   |
  | PUT  | /users/me        | 更新当前登录用户信息       |  √   |
  | GET  | /users/{user_id} | 获取指定ID的用户信息       | 待办 |

- 备注：
  - 头像通过 Base64 编码上传，后端解码并存储文件。
  - 密码更新时会重新哈希。

## 2. 房间管理

| 需求描述                                       |   状态   |
| ---------------------------------------------- |:--------:|
| 房主创建房间                                   |    √     |
| 房主解散房间                                   |    √     |
| 获取房间基本信息                               |    √     |
| 获取房间详细信息 (含房主、成员列表)            |    √     |
| 房主更新房间信息 (如名称)                      |    √     |
| **邀请/申请加入房间流程 (通过通知系统)**       |    √     |
|   - 房主邀请用户加入                           |    √     |
|   - 用户申请加入房间                           |    √     |
|   - 成员邀请其他用户加入                       |    √     |
| 用户实际加入/退出房间 (接受/拒绝邀请后的操作)  |   部分   |
| 房间页面根据身份展示不同内容 (后端权限支持)    |   待办   |
| 房间参数设置（公开、同意、聊天记录、同步等）   |   待办   |

- 相关模块：
  - `app/api/rooms.py`
  - `app/crud/rooms.py`
  - `app/crud/notifications.py` (用于邀请/申请流程)
  - `app/models.py` (Room, room_members models)
  - `app/schemas.py` (Room schemas)
- 相关API：

  | 方法   | 路径                      | 说明                                     | 状态 |
  | ------ | ------------------------- | ---------------------------------------- |:----:|
  | POST   | /rooms/                   | 创建房间                                 |  √   |
  | DELETE | /rooms/{room_id}          | 解散房间 (仅房主)                        |  √   |
  | GET    | /rooms/{room_id}          | 获取房间基本信息                         |  √   |
  | GET    | /rooms/{room_id}/details  | 获取房间详细信息                         |  √   |
  | PUT    | /rooms/{room_id}          | 更新房间信息 (仅房主)                    |  √   |
  | POST   | /rooms/{room_id}/members  | 发起邀请/申请加入房间 (创建通知)         |  √   |
  | POST   | /rooms/join               | (原) 用户加入房间 (逻辑已整合或待重构)   | 待议 |
  | POST   | /rooms/leave              | (原) 用户退出房间 (逻辑待实现)           | 待办 |
  | PUT    | /rooms/{id}/config        | (原) 修改房间参数 (逻辑待实现)           | 待办 |


- 备注：
  - 当前用户加入房间的流程是通过 `POST /rooms/{room_id}/members` 创建通知，实际的成员添加/移除逻辑（例如，在用户接受邀请后）需要进一步完善。
  - `crud.add_room_member` 和 `crud.remove_room_member` 函数已存在，但未在API层面完全整合。
  - 房间参数设置、房主/宾客身份区分、页面展示差异需前后端配合实现。

## 3. 通知系统

| 需求描述                                       |   状态   |
| ---------------------------------------------- |:--------:|
| 用户通知表 (`Notification`) 设计与实现         |    √     |
| 支持房间邀请/申请等事件的通知创建              |    √     |
| API：查询当前用户通知列表 (支持分页、状态筛选) |    √     |
| API：标记通知为已读                            |   待办   |
| API：删除通知                                  |   待办   |
| API：清空所有通知                              |   待办   |
| 在线用户通过WebSocket实时推送通知              |   待办   |
| 离线用户下次登录自动拉取未读通知 (前端实现)    |   部分   |
| 通知表定期清理与归档                           |   待办   |

- 相关模块：
  - `app/models.py` (Notification model)
  - `app/api/notifications.py`
  - `app/crud/notifications.py`
  - `app/api/rooms.py` (在邀请/申请时创建通知)
  - `app/schemas.py` (Notification schemas)
- 相关API：

  | 方法   | 路径                        | 说明                                 | 状态 |
  | ------ | --------------------------- | ------------------------------------ |:----:|
  | GET    | /notifications/             | 查询当前用户通知 (支持分页和状态)    |  √   |
  | PUT    | /notifications/{id}/read    | 标记通知为已读                       | 待办 |
  | DELETE | /notifications/{id}         | 删除指定通知                         | 待办 |
  | DELETE | /notifications/clear        | 清空当前用户所有通知                 | 待办 |

- 相关说明：
  - 通知内容目前为 JSON 字符串，包含事件类型和相关 ID。
  - 通知状态 (如 "pending", "unread", "accepted", "rejected") 需要更明确地定义和使用。
  - 实时推送依赖 WebSocket 功能的实现。

## 4. WebSocket 实时通信与在线状态

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 提供 WebSocket 连接接口                    |   待办   |
| 用户身份认证与连接管理                     |   待办   |
| 用户在线状态维护与心跳机制                 |   待办   |
| 房间内实时数据同步（如播放、消息等）        |   待办   |
| 支持断线重连与异常处理                     |   待办   |

- 相关模块：
  - (预计) `app/ws/` 或 `app/api/ws_rooms.py`
  - `app/models.py` (可能需要扩展以记录在线状态或最后活动时间)
- 相关说明：
  - 这是项目的核心功能之一，目前尚未开始实现。
  - 需要设计 WebSocket 端点，如 `ws://.../ws/rooms/{room_id}`。
  - 连接建立时需校验用户身份（如 JWT Token）。
  - 考虑使用 FastAPI 的 WebSocket 支持。
  - 消息协议格式（如 type/payload）需要详细定义。

### 4.1 WebSocket 消息类型一览 (规划)

| 类型                | 描述                         | 方向         | 状态 |
|---------------------|------------------------------|--------------|:----:|
| `connection_ack`    | 连接成功确认                 | 后端→前端    | 规划 |
| `heartbeat`         | 心跳包，维持连接与在线状态   | 双向         | 规划 |
| `user_joined_room`  | 用户加入房间通知             | 后端→房间广播| 规划 |
| `user_left_room`    | 用户离开房间通知             | 后端→房间广播| 规划 |
| `play_control`      | 播放控制（播放/暂停/跳转）   | 前端→后端/房间广播 | 规划 |
| `progress_update`   | 播放进度更新                 | 前端→后端/房间广播 | 规划 |
| `chat_message_send` | 发送聊天消息                 | 前端→后端    | 规划 |
| `chat_message_broadcast`| 广播聊天消息             | 后端→房间广播| 规划 |
| `notification_new`  | 新通知推送                   | 后端→前端    | 规划 |
| `error_message`     | 错误信息                     | 后端→前端    | 规划 |

- 方向说明：
  - 前端→后端：由前端发送到后端。
  - 后端→前端：由后端点对点推送到特定前端。
  - 后端→房间广播：后端收到后广播给房间内所有在线成员。
  - 双向：前后端均可发起。

- 备注：
  - 每条消息建议包含 `type` (消息类型) 和 `payload` (具体数据) 字段。

## 5. 聊天消息 (Message)

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 聊天消息模型 (`Message`) 设计与实现        |    √     |
| API：发送聊天消息 (通过WebSocket)          |   待办   |
| API：获取房间历史聊天消息 (分页)           |   待办   |
| 聊天消息持久化存储                         |    √     |

- 相关模块：
  - `app/models.py` (Message model)
  - `app/crud/messages.py` (目前被注释，需启用和完善)
  - `app/schemas.py` (Message schemas)
- 相关API (规划中，主要通过WebSocket):
  | 方法 | 路径                        | 说明               | 状态 |
  | ---- | --------------------------- | ------------------ |:----:|
  | GET  | /rooms/{room_id}/messages   | 获取历史聊天消息   | 待办 |

- 备注：
  - `crud/messages.py` 中的代码目前被注释掉了，需要重新审视并启用。
  - 实时消息发送将通过 WebSocket 实现。

## 6. 权限控制

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 细化API接口的权限校验                      |   部分   |
|   - 例如：只有房主能解散房间、修改房间信息 |    √     |
|   - 例如：只有房间成员才能进行某些操作     |   待办   |
| 基于角色的访问控制 (RBAC) - (可选/未来)  |   规划   |

- 备注：
  - 目前主要通过 `get_current_user` 和检查用户ID与房主ID是否一致来实现简单的权限控制。
  - 未来可以考虑更通用的权限依赖项或中间件。

## 7. 数据库迁移 (Alembic)

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| Alembic 配置与环境设置                     |    √     |
| 已有模型对应的迁移脚本                     |    √     |
|   - `31ba4580cbae_update_id_sequences.py`  |    √     |
|   - (其他早期迁移脚本)                     |    √     |

- 相关模块：
  - `alembic/` 目录
  - `alembic.ini`
- 备注：
  - 确保模型变更时及时生成和应用新的迁移脚本。

## 8. 其他

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 静态文件服务 (avatars, general static)     |    √     |
| CORS 配置                                  |    √     |
| 应用生命周期管理 (数据库表创建)            |    √     |
| Dockerfile 用于构建后端镜像                |    √     |
| 单元测试/集成测试                          |   待办   |
| 日志记录                                   |   待办   |
| API 文档 (FastAPI 自动生成)                |    √     |

> 请在此文件中持续补充和更新后端开发需求。
