# 后端开发需求记录

本文件用于记录 backend 目录下后端开发的需求、任务、变更及相关说明。

# 需求列表

## 0. 需求记录模板
   - 需求描述：
     - 用简明的条目描述该需求要实现的功能或目标。
   - 相关模块：
     - 涉及的主要代码文件或目录（如 app/api/xxx.py、app/crud/xxx.py 等）。
   - 相关API：
     - 用表格列出涉及的接口（如 POST /users/ 注册）。
   - 备注：
     - 其他需要注意的事项、实现建议或特殊说明。

## 1. 用户管理

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 用户注册与登录                             |    √     |
| 邮箱和用户名唯一性校验                     |    √     |
| 密码加密存储                               |    √     |
| JWT鉴权，Token刷新                         |    √     |
| 用户信息查询（当前/指定用户）               |          |
| 个人信息更新（用户名、头像、密码）          |    √     |

- 相关模块：
  - app/api/users.py
  - app/crud/users.py
  - app/models.py
  - app/schemas.py
- 相关API：

  | 方法 | 路径             | 说明             | 状态 |
  | ---- | ---------------- | ---------------- |:----:|
  | POST | /users/          | 注册             |  √   |
  | POST | /token           | 登录             |  √   |
  | POST | /token/refresh   | 刷新Token        |  √   |
  | GET  | /token/check     | 校验Token        |  √   |
  | GET  | /users/me        | 获取当前用户信息 |  √   |
  | GET  | /users/{user_id} | 获取指定用户信息 |      |
  | PUT  | /users/me        | 更新当前用户信息 |  √   |

- 备注：

## 2. 房间管理

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 房主创建/解散房间，用户加入/退出房间       |          |
| 房主邀请用户、用户申请加入房间             |          |
| 房间页面根据身份展示不同内容               |          |
| 房间参数设置（公开、同意、聊天记录、同步） |          |

- 相关模块：
  - app/api/rooms.py
  - app/crud/rooms.py
  - app/models.py
  - app/schemas.py
- 相关API：

  | 方法   | 路径                | 说明               | 状态 |
  | ------ | ------------------- | ------------------ |:----:|
  | POST   | /rooms/             | 创建房间           |      |
  | DELETE | /rooms/{id}         | 解散房间           |      |
  | POST   | /rooms/join         | 加入房间           |      |
  | POST   | /rooms/leave        | 退出房间           |      |
  | POST   | /rooms/invite       | 邀请用户           |      |
  | POST   | /rooms/apply        | 申请加入房间       |      |
  | PUT    | /rooms/{id}/config  | 修改房间参数       |      |

- 备注：
  - 房间参数设置、房主/宾客身份区分、页面展示差异需前后端配合实现。
  - 需与前端参数配置界面联动，部分参数需实时同步。

## 3. 通知系统

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 用户通知表设计与实现                       |          |
| 支持房主邀请等事件的通知推送               |          |
| 通知API：查询、标记已读、删除等            |          |
| 在线用户通过WebSocket实时推送通知          |          |
| 离线用户下次登录自动拉取未读通知           |          |
| 通知表定期清理与归档                       |          |

- 相关模块：
  - app/models.py（通知表设计）
  - app/api/notifications.py（通知API）
  - app/crud/notifications.py
  - app/api/rooms.py（邀请相关逻辑）
- 相关API：

  | 方法 | 路径                        | 说明               | 状态 |
  | ---- | --------------------------- | ------------------ |:----:|
  | GET  | /notifications/             | 查询当前用户通知   |      |
  | PUT  | /notifications/{id}/read    | 标记通知为已读     |      |
  | DELETE | /notifications/{id}       | 删除通知           |      |
  | DELETE | /notifications/clear      | 清空所有通知       |      |

- 相关说明：
  - 通知表建议单独设计，包含user_id、type、content、status、created_at等字段。
  - 通知插入后，若用户在线，通过WebSocket推送通知消息。
  - 用户不在线时，前端下次登录主动拉取未读通知。
  - 支持API查询、标记已读、删除等操作。
  - 建议定期清理已读/过期通知，或采用软删除。

- 备注：
  - 通知系统可扩展为系统消息、好友请求等多类型。
  - 高并发场景下可考虑缓存优化。

## 4. WebSocket 实时通信与在线状态

| 需求描述                                   |   状态   |
| ------------------------------------------ |:--------:|
| 提供 WebSocket 连接接口                    |          |
| 用户身份认证与连接管理                     |          |
| 用户在线状态维护与心跳机制                 |          |
| 房间内实时数据同步（如播放、消息等）        |          |
| 支持断线重连与异常处理                     |          |

- 相关模块：
  - app/api/rooms.py 或单独 ws.py
  - app/models.py（如需记录在线状态）
  - app/utils/（如有心跳、消息协议工具）
- 相关说明：
  - 提供 ws://.../ws/rooms/{room_id} 等 WebSocket 连接入口。
  - 连接建立时需校验用户身份（如 JWT Token）。
  - 需维护每个在线用户的连接对象，支持心跳包机制，定期检测掉线。
  - 支持房间内消息、播放控制等实时广播与点对点推送。
  - 需支持前端断线重连，后端自动恢复用户在线状态。
  - 建议统一消息协议格式（如 type/payload）。

### 4.1 WebSocket 消息类型一览

| 类型                | 描述                         | 方向         | 状态 |
|---------------------|------------------------------|--------------|:----:|
| heart_beat          | 心跳包，维持连接与在线状态   | 双向         |      |
| user_status         | 用户上线/下线通知            | 后端→前端    |      |
| play_control        | 播放控制（播放/暂停/同步进度）| 前端→后端/房间广播 |      |
| progress_sync       | 播放进度同步                 | 前端→后端/房间广播 |      |
| chat_message        | 聊天消息                     | 前端→后端/房间广播 |      |
| invite_notification | 房主邀请用户通知             | 后端→前端    |      |
| notification        | 通用通知（如系统消息）        | 后端→前端    |      |
| room_event          | 房间事件（如成员加入/离开）   | 后端→前端    |      |
| error               | 错误信息                     | 后端→前端    |      |
| custom_event        | 预留自定义事件               | 双向         |      |

- 方向说明：
  - 前端→后端：由前端发送到后端
  - 后端→前端：由后端推送到前端
  - 房间广播：后端收到后广播给房间内所有成员
  - 双向：前后端均可发送

- 备注：
  - 可根据业务扩展更多 type 类型，前后端需保持协议一致。
  - 每条消息建议包含 type、payload 字段。


## 5. 权限控制


> 请在此文件中持续补充和更新后端开发需求。
